<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<title data-react-helmet="true">Metrics | Node.JS Reference Architecture</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://nodeshift.dev/nodejs-reference-architecture/operations/metrics"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Metrics | Node.JS Reference Architecture"><meta data-react-helmet="true" name="description" content="Recommended packages"><meta data-react-helmet="true" property="og:description" content="Recommended packages"><link data-react-helmet="true" rel="shortcut icon" href="/nodejs-reference-architecture/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://nodeshift.dev/nodejs-reference-architecture/operations/metrics"><link data-react-helmet="true" rel="alternate" href="https://nodeshift.dev/nodejs-reference-architecture/operations/metrics" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://nodeshift.dev/nodejs-reference-architecture/operations/metrics" hreflang="x-default"><link rel="stylesheet" href="/nodejs-reference-architecture/assets/css/styles.c2e2bee9.css">
<link rel="preload" href="/nodejs-reference-architecture/assets/js/runtime~main.509bdb81.js" as="script">
<link rel="preload" href="/nodejs-reference-architecture/assets/js/main.8ac72c68.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/nodejs-reference-architecture/"></a></div><div class="navbar__items navbar__items--right"><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/nodejs-reference-architecture/">Node.js Reference Architecture</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist" href="#">Development</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/nodejs-reference-architecture/development/building-good-containers">Building Good Containers</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/nodejs-reference-architecture/development/code-consistency">Code Consistency</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/nodejs-reference-architecture/development/npm-proxy">Npm Proxy / Internal Registry</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/nodejs-reference-architecture/development/npm-publishing">Npm Publishing Guidelines</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/nodejs-reference-architecture/development/testing">Testing</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/nodejs-reference-architecture/development/typescript">Typescript</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/nodejs-reference-architecture/development/code-coverage">Code Coverage</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist" href="#">Functional components</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/nodejs-reference-architecture/functional-components/apifirst">REST APIs Development</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/nodejs-reference-architecture/functional-components/auth">Authentication</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/nodejs-reference-architecture/functional-components/data-caching">Data Caching</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/nodejs-reference-architecture/functional-components/databases">Databases</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/nodejs-reference-architecture/functional-components/graphql">GraphQL Development</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/nodejs-reference-architecture/functional-components/internationalization">Internationalization</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/nodejs-reference-architecture/functional-components/message-queuing">Message Queuing</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/nodejs-reference-architecture/functional-components/nodejs-versions-images">Node.js Versions and Container Images</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/nodejs-reference-architecture/functional-components/scaling-multi-threading">Scaling and Multi-threading</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/nodejs-reference-architecture/functional-components/static-assets">Static assets</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/nodejs-reference-architecture/functional-components/template-engines">Template Engines (Server Side)</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/nodejs-reference-architecture/functional-components/webframework">Web Framework</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Operations</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/nodejs-reference-architecture/operations/distributed-tracing">Distributed Tracing</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/nodejs-reference-architecture/operations/failurehandling">Fault Tolerance</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/nodejs-reference-architecture/operations/healthchecks">Health Checks</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/nodejs-reference-architecture/operations/logging">Logging</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/nodejs-reference-architecture/operations/metrics">Metrics</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Metrics</h1></header><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="recommended-packages"></a>Recommended packages<a class="hash-link" href="#recommended-packages" title="Direct link to heading">#</a></h2><ul><li><p><a href="https://www.npmjs.com/package/prom-client" target="_blank" rel="noopener noreferrer">prom-client</a>. With &gt;300k weekly downloads
prom-client is both the most used and most flexible prometheus client. It also has
a shallow dependency tree.</p></li><li><p><a href="https://www.npmjs.com/package/express-prom-bundle" target="_blank" rel="noopener noreferrer">express-prom-bundle</a>, version 5
or later. It is based on prom-client and if you are using the Express web
framework this is a good way to export prometheus metrics. It&#x27;s more succinct
to use to get started, but also more opinionated. Its a reasonable option
until/unless more control or custom metrics are needed.</p></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="guidance"></a>Guidance<a class="hash-link" href="#guidance" title="Direct link to heading">#</a></h2><ul><li><p>Export prometheus endpoints for containers running Node.js applications. Without
these end points it can be difficult monitor your applications. Prometheus is
the defacto standard for exposing metrics in Cloud Native applications. Further
Cloud Native infrastructure (Kubernetes distributions) make it easily to collect
prometheus metrics and it is also easy to collect and graph even if you need
to install the infrastructure components.</p></li><li><p>Collect and monitor &quot;RED&quot; metrics. Details are available in</p><ul><li><a href="https://medium.com/faun/how-to-monitor-the-sre-golden-signals-1391cadc7524" target="_blank" rel="noopener noreferrer">https://medium.com/faun/how-to-monitor-the-sre-golden-signals-1391cadc7524</a></li><li><a href="https://www.weave.works/blog/the-red-method-key-metrics-for-microservices-architecture/" target="_blank" rel="noopener noreferrer">https://www.weave.works/blog/the-red-method-key-metrics-for-microservices-architecture/</a></li></ul></li><li><p>For HTTP expose the <code>RED</code> metrics as:</p><ul><li>request rate - requests which are handled ok (status code==2xx). Expose this as the total
count.</li><li>error rate - requests which are not handled ok ( status code!=2xx). Expose this metric
as a percentage of the total rate.</li><li>request latency - duration of requests which are handled ok, grouped into ranges/buckets and
exposed through a prometheus histogram.</li></ul></li><li><p><a href="https://github.com/csantanapr/prometheus-nodejs-tutorial" target="_blank" rel="noopener noreferrer">prometheus-nodejs-tutorial</a> provides
examples of using prom-client and express-prom-bundle to collect metrics. Lab 3 and 6
show how to generate the http_request_duration_seconds_bucket metric.</p><p>Configure prometheus middleware as the first middleware to start the timer as soon as possible.
When setting up the middleware define your expose route for metrics <code>/metrics</code> before activating the middleware
to avoid calls to <code>/metrics</code> to be counted as part of the metrics, you can do the same for
liveness and readiness checks to define them before prometheus middleware if you want to discard them from your
http metrics calculations.</p><p>For success rate the prometheus query would be
<code>sum(rate(http_request_duration_seconds_count{code=&quot;2xx&quot;, app=&quot;myapp&quot;}[5m]))</code>.
The sum over all instances, the rate of change of the request count for app
my app with status_code 2xx over a 5m window</p><p>For error rate, but the status_code is usually 4xx or 5xx expressed as [45]xx. The
prometheus query would be <code>sum(rate(http_request_duration_seconds_count{code=&quot;[45]xx&quot;, app=&quot;myapp&quot;}[5m]))</code>.</p><p>For duration, or latency the metric is a histogram so you will graph and
monitor percentiles instead of a summary. For example, the prometheus query would be
to get the 95 percentile over all instances over 5m window would be
<code>histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{code=&quot;2xx&quot;, app=&quot;myapp&quot;}[5m]))</code></p></li><li><p>Export additional custom metrics to provide key attributes about the operation of
your application which are not part of the standard metrics.</p></li><li><p>Be aware that the prometheus client instance needs to be a singleton within your app. For example, if your
application imports separate packages that utilize the &quot;prom-client&quot; package, like customized RabbitMQ &amp;
Redis drivers that write metrics to prom-client, you need to make sure they use the same prom-client instance.
A common way to do that is to make the prom-client instance as an optional parameter in the constructor for
those drivers, and then your app can pass in the same prom-client instance into both.</p></li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/nodeshift/nodejs-reference-architecture/docs/operations/metrics.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/nodejs-reference-architecture/operations/logging"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Logging</div></a></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#recommended-packages" class="table-of-contents__link">Recommended packages</a></li><li><a href="#guidance" class="table-of-contents__link">Guidance</a></li></ul></div></div></div></div></main></div></div></div>
<script src="/nodejs-reference-architecture/assets/js/runtime~main.509bdb81.js"></script>
<script src="/nodejs-reference-architecture/assets/js/main.8ac72c68.js"></script>
</body>
</html>